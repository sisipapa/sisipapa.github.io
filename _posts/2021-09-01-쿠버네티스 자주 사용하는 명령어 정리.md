---
layout: post
title: 쿠버네티스 자주 사용하는 명령어 정리
category: [k8s]
tags: [k8s, kubectl]
redirect_from:

- /2021/09/01/

---

현재 쿠버네티스를 사용하면서 자주 사용하고 있는 명령어 및 유용한 Kubernetes CLI 명령어들을 정리해 두려고 한다. 매번 뭐였더라 하면서 인터넷 검색을 해왔는데 오늘이라도 노트에 정리해 보려고 한다.

## 리소스 조회
kubectl get + Resource명을 붙여서 조회한다. Resource의 종류에는 namespace, node, pod, svc, deployment, pv, pvc, configmap, secret 등이 있다.  
pod Resource의 경우는 IP,NODE,NOMINATED NODE,READINESS GATES 정보를 추가로 확인이 가능하다.  
```shell
# 기본조회  
$ kubectl get pod 

AME                      READY   STATUS    RESTARTS   AGE   
aaa-pod                  1/1     Running   0          7d18h

# 옵션을 통한 상세조회
$ kubectl get pod -o wide

AME                      READY   STATUS    RESTARTS   AGE     IP              NODE             NOMINATED NODE   READINESS GATES
aaa-pod                  1/1     Running   0          7d18h   10.244.3.137    cluster-01       <none>           <none>

# 상세 출력을 위한 Describe 커맨드
kubectl describe nodes my-node
kubectl describe pods my-pod

# Name으로 정렬된 서비스의 목록 조회
kubectl get services --sort-by=.metadata.name

# 재시작 횟수로 정렬된 파드의 목록 조회
kubectl get pods --sort-by='.status.containerStatuses[0].restartCount'

# PersistentVolumes을 용량별로 정렬해서 조회
kubectl get pv --sort-by=.spec.capacity.storage
```  

## 오브젝트 생성  
```shell
# 파일이 있을 경우
$ kubectl create -f ./pod-multi-container.yaml

# stdin으로 단일 YAML 오브젝트 생성
$ kubectl create -f - <<END
apiVersion: v1
kind: Pod
metadata:
  name: pod-init
spec:
  containers:
  - name: container
    image: coolguy239/init
END  

# stdin으로 다수의 YAML 오브젝트 생성
$ cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: busybox-sleep
spec:
  containers:
  - name: busybox
    image: busybox
    args:
    - sleep
    - "1000000"
---
apiVersion: v1
kind: Pod
metadata:
  name: busybox-sleep-less
spec:
  containers:
  - name: busybox
    image: busybox
    args:
    - sleep
    - "1000"
EOF
```  

## 로그확인
```shell
# app이 web인 파드 로그 조회
$ kubectl logs -f -l app=web

# 특정 파드만의 로그 확인 since 옵션을 주지 않으면 pod가 배포된 처음 로그부터 출력된다.
$ kubectl logs -f web-7bf57cd587-67vl5 --since=1m
```  

## 파드의 컨테이너 접속  
```shell
# 단일 Container의 경우
$ kubectl exec -ti web-7bf57cd587-67vl5 bash 

# 하나의 파드에 Multi Container로 구성된 경우
$ kubectl exec -ti -c container-name web-7bf57cd587-67vl5 bash
```  

## Pod의 리소스 사용량 조회  
```shell
# CPU 높은순 
$ kubectl top pod --sort-by cpu | grep batch

# MEMORY 높은순 
$ kubectl top pod --sort-by memory | grep batch
```  

## events 조회  
현재 운영중인 시스템에서 pod의 상태를 체크하는 배치가 돌면서 문제가 있을때 알람을 보내주는데 아무런 장애없이 pod의 running 상태가 1/1 아닌 0/1인 경우 알람이 오게 된다. evnet 확인을 위해 아래 명령어를 실행한다.
```shell
$ kubectl get events

LAST SEEN   TYPE      REASON      OBJECT                     MESSAGE
18s         Warning   Unhealthy   pod/web-7bf57cd587-m9qkp   Readiness probe failed: xxx
10m         Warning   Unhealthy   pod/web-7bf57cd587-m9qkp   Readiness probe failed: xxx
```  

## 배포  
```shell
# Rollout history(현 리비전을 포함한 디플로이먼트의 이력을 체크)
$ kubectl rollout history deployment/service1

# Rollout
kubectl rollout restart deploy/service1

# Rollout 중단(1대 배포 완료되고)
kubectl rollout pause deploy/service1

# Rollout 재개
kubectl rollout resume deploy/service1

# undo1(이전 디플로이먼트로 롤백 | 파드 한대만 배포 후 정상확인이 안되면 resume이 아닌 undo)
kubectl rollout undo deploy/service1

# undo2(특정 리비전으로 롤백)
kubectl rollout undo deploy/service1 --to-revision=86  

# pod 삭제
kubectl delete pod [pod name]             
```  

## 참고  
[Kubernetes 공식 Document](https://kubernetes.io/ko/docs/reference/kubectl/cheatsheet/)
