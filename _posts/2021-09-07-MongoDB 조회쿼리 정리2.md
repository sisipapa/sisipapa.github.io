---
layout: post 
title: MongoDB 조회쿼리 정리2
category: [mongodb]
tags: [mongodb]
redirect_from:

- /2021/09/07/

---

업무에서 간단한 검색어 검색이나 카운트 조회를 할 때는 find를 사용하지만 쿼리 중 grouping, filtering이 들어가게 되면 find로는 처리를 할 수가 없다. 그래서 오늘은 평소에 많이 사용하고 있는 Aggregation Framework Pipeline의 예제들과 정리를 해보려고 한다.    

## Aggregation  
- MongoDB의 Aggregation은 Sharding 기반의 데이터를 효율적으로 처리하고 집계하는 프레임워크이다.
- documents를 grouping, filtering 등 다양한 연산을 적용하여 계산된 결과를 반환한다.

## $match
SQL의 WHERE 절에 해당한다. 원하는 데이터를 추출하기 위한 Filtering 역할을 한다.   

### $exists 
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            'iUm' : {'$exists' : true}
        }
    }
])
```

### $eq
SQL의 Equal(=) 조회에 해당한다.
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            _id : {'$eq' : '540a4c8705273b05-306f3a1d163f2ba6641-7f3f'}
        }
    }
])
```

### $ne
SQL의 Not Equal(!=) 조회에 해당한다.
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            _id : {'$ne' : '540a4c8705273b05-306f3a1d163f2ba6641-7f3f'}
        }
    }
])
```  

### $in
SQL의 IN절 조회에 해당한다.
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            _id : {'$in' : ['540a4c8705273b05-306f3a1d163f2ba6641-7f3f','b776f5c16d3eaa8266a6f4f31737e25768b-3219']}
        }
    }
])
```  

### $nin
SQL의 NOT IN절 조회에 해당한다.
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            _id : {'$nin' : ['540a4c8705273b05-306f3a1d163f2ba6641-7f3f','b776f5c16d3eaa8266a6f4f31737e25768b-3219']}
        }
    }
])
```  

### $limit
SQL의 LIMIT와 동일하다.
```json
db.getCollection('CIData_00').aggregate([
    {
        '$match' : {
            _id : {'$nin' : ['540a4c8705273b05-306f3a1d163f2ba6641-7f3f','b776f5c16d3eaa8266a6f4f31737e25768b-3219']}
        }
    },
   {
     '$limit' : 5
   }
])
```  

### $and
$and 조건은 Array type이고 한 개 이상의 JSON 형태의 조건을 입력해야 한다. 
```json
db.getCollection('CIData_00').aggregate([
  {
    '$match' : {
      '$and' : [
        {_id : {'$nin' : ['540a4c8705273b05-306f3a1d163f2ba6641-7f3f','b776f5c16d3eaa8266a6f4f31737e25768b-3219']}}
       ,{'key' : '000108f3c0db54c9-290fb41a165787def261e9d'}
      ]
    }
  }
])

// between A and B - 검색 조건 필드의 type이 date인 경우
db.getCollection('CIData_00').aggregate([
  {
    '$match' : {
      '$and' : [
        {'last_update_datetime' : {'$gt' : ISODate('2021-09-01T00:00:00Z')}}
      ,{'last_update_datetime' : {'$lt' : ISODate('2021-09-06T00:00:00Z')}}
      ]
    }
  }
])

// between A and B - 검색 조건 필드의 type이 String인 경우
db.getCollection('CIData_00').aggregate([
  {
    '$match' : {
      '$and' : [
        {'iUm.data.insDate' : {'$gt' : '20210901'}}
      ,{'iUm.data.insDate' : {'$lt' : '20210906'}}
      ]
    }
  }
])
```  

### $regex  
```json
db.getCollection('CIData_00').aggregate([
  {
    $match : {
      'iUm.data.insDate' : {$regex : /^20210901/}
    }
  }
])
```  

## $Project
Collection 필드 중 원하는 필드를 조회할 때 사용한다.  

### 전체 Collection 필드 중 _id, iUm 필드만 조회  
_id 필드는 명시적으로 false를 선언하지 않으면 출력된다.   
```json
db.getCollection('CIData_00').aggregate([
    {
        '$project' : {
            '_id' : false
            ,'id' : '$_id'
            ,'um' : '$iUm'
        }
    }
])
```  

### $indexOfArray(A, B)를 이용해 A Array중 B값이 몇 번째 인덱스에 해당하는 지 조회    
```json
db.getCollection('CIData_00').aggregate([
  {
    $project : {
     'ageIndex' : {
        $indexOfArray : ['$iAge2.data', {$max: '$iAge2.data'}]
      }
    }
  }
])
```  

### $substr($substrCP)을 이용한 데이터 조작
```json
db.getCollection('CIData_00').aggregate([
  {
    $project : {
        'id_substr' : { $substrCP: [ '$_id', 0, 8 ] }
    }
  }
])
```  
### $cond, if~then 구문을 이용해 SQL의 case when 구현
```json
db.getCollection('CIData_00').aggregate([
    {
        $project:{
            'PC':{$cond:{'if':{$eq:['$saveCnt.device', 'P']}, 'then':1, 'else':0}},
            'MOBILE':{$cond:{'if':{$eq:['$saveCnt.device', 'M']}, 'then':1, 'else':0}},
            'UNKNOWN':{$cond:{'if':{$eq:['$saveCnt.device', 'UNKNOWN']}, 'then':1, 'else':0}}
        }
    }    
])
```  
### $setUnion으로 iUm, iHu에서 domain필드만 추출해서 Array로 만들기.
```json
db.getCollection('CIData_00').aggregate([
    {
        $match: {
            $and : [
                {'iUm' : {'$exists' : true}}
                ,{'iHu' : {'$exists' : true}}
            ]
        }
    }
    ,{
        $project:{
            'domains' : {
                '$setUnion' : ['$iUm.data.domain', '$iHu.data.domain']
            } 
        }
    }    
])
```  

### $setUnion으로 조회한 Array의 사이즈 조회
```json
db.getCollection('CIData_00').aggregate([
    {
        $match: {
            $and : [
                {'iUm' : {'$exists' : true}}
                ,{'iHu' : {'$exists' : true}}
            ]
        }
    }
    ,{
        $project:{
            'CNT' : {
                '$size' : {
                    '$setUnion' : ['$iUm.data.domain', '$iHu.data.domain']
                }
            }
        }
    }    
])
```  

## $group  

### Collection 전체 카운트
```json
db.getCollection('CIData_00').aggregate([
  {
        '$group' : {
            '_id' : null
            , 'COUNT' : {$sum:1}
        }
  }
])
```

## sort  
sort는 DB나 MongoDB 모두 부하가 많이 가기 때문에 10건으로 제한을 해서 테스트를 진행. sort를 위한 필드의 값이 -1이면 desc, 1이면 asc 이다.  
```json
db.getCollection('CIData_00').aggregate([
  {
    '$limit' : 10
  }
,{ $sort : { 'last_update_datetime' : -1 } }
])
```
